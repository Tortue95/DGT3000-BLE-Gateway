# DGT3000 BLE Gateway Protocol Documentation

## 1. Overview
This document describes the Bluetooth Low Energy (BLE) protocol for the DGT3000 Gateway. The gateway acts as a bridge, allowing a client (e.g., a mobile application) to communicate with a DGT3000 chess clock via a JSON-based request/response and event notification system.

**BLE Device Name**: `DGT3000-Gateway`

**Communication**: All communication, except for protocol version reads, is handled through JSON strings written to and notified from specific characteristics.

## 2. BLE Service and Characteristics
The gateway exposes a single primary service with several characteristics to handle communication.

**Service UUID**: `73822f6e-edcd-44bb-974b-93ee97cb0000`

### Characteristics
| Name             | UUID                             | Properties | Description                                                                                             |
|------------------|----------------------------------|------------|---------------------------------------------------------------------------------------------------------|
| Protocol Version | `73822f6e-edcd-44bb-974b-93ee97cb0001` | Read       | A read-only characteristic that returns the gateway's protocol version string (e.g., "1.0").             |
| Command          | `73822f6e-edcd-44bb-974b-93ee97cb0002` | Write      | Clients write JSON command strings to this characteristic to control the DGT3000 clock.                 |
| Event            | `73822f6e-edcd-44bb-974b-93ee97cb0003` | Notify     | Clients must subscribe to notifications on this characteristic. The gateway sends all asynchronous events and command responses here. |
| Status           | `73822f6e-edcd-44bb-974b-93ee97cb0004` | Read       | A read-only characteristic that returns a JSON string containing the current status of the gateway and the DGT3000 clock. |

## 3. Communication Flow

### Initialization Procedure (Client to Gateway)
To establish a stable and functional connection with the DGT3000 Gateway, the client should follow these steps:

1.  **Scan and Connect**: Discover BLE devices and connect to the `DGT3000-Gateway` device.
2.  **Read Protocol Version**: Read the `Protocol Version` characteristic (`...-0001`) to ensure compatibility. The current expected version is `"1.0"`.
3.  **Subscribe to Events**: Subscribe to notifications on the `Event` characteristic (`...-0003`). This is critical for receiving command responses and asynchronous events.
4.  **Wait for DGT3000 Configuration**: After subscribing, the gateway will attempt to initialize and configure the physical DGT3000 clock. The client should wait for a `connectionStatus` event with `data.configured: true` to confirm that the DGT3000 clock is ready for commands. This event signifies that the gateway has successfully established I2C communication and configured the clock.
    *   **Timeout**: It is recommended to implement a timeout (e.g., 7-10 seconds) for this step. If the `configured: true` event is not received within the timeout, the connection should be considered unstable, and the client may attempt to reconnect or inform the user.
5.  **Ready for Commands**: Once the `connectionStatus` event with `configured: true` is received, the gateway is fully operational, and the client can begin sending commands.

### General Interaction
The interaction is asynchronous and follows a clear pattern:

1.  **Connection**: The client connects to the `DGT3000-Gateway` device.
2.  **Subscription**: The client must subscribe to notifications on the `Event` Characteristic (`...-0003`). This is the primary channel for receiving data from the gateway.
3.  **Command Execution**: The client sends a command by writing a JSON string to the `Command` Characteristic (`...-0002`).
4.  **Response**: The gateway processes the command and sends a JSON response via a notification on the `Event` Characteristic.
5.  **Asynchronous Events**: The gateway can send unsolicited events (like button presses, time updates) at any time, also via notifications on the `Event` Characteristic.

## 4. Commands (Client â†’ Gateway)
All commands are sent as a single JSON object string to the `Command` characteristic (`...-0002`).

### Generic Command Structure
```json
{
  "command": "commandName",
  "id": "unique_command_id",
  "params": {
    "param1": "value1",
    "param2": 123
  }
}
```
*   `command` (string, required): The name of the command to execute.
*   `id` (string, required): A unique identifier for the command, generated by the client. This ID will be present in the corresponding response (`command_response`) to match requests with responses. Maximum length: 31 characters.
*   `params` (object, optional): An object containing the parameters for the command. Required for commands that need specific data.

### Command Reference

#### `setTime`
Sets the time on both sides of the clock and starts the clock in a stopped state.

**Params**:
| Name        | Type    | Description                                                                                             | Constraints                     |
|-------------|---------|---------------------------------------------------------------------------------------------------------|---------------------------------|
| `leftMode`  | `uint8` | DGT mode for the left timer. Determines how the timer behaves.                                          | `0` (STOP) <br> `1` (COUNT_DOWN) <br> `2` (COUNT_UP) |
| `leftHours` | `uint8` | Hours for the left timer.                                                                               | `0-9`                           |
| `leftMinutes` | `uint8` | Minutes for the left timer.                                                                             | `0-59`                          |
| `leftSeconds` | `uint8` | Seconds for the left timer.                                                                             | `0-59`                          |
| `rightMode` | `uint8` | DGT mode for the right timer. Determines how the timer behaves.                                         | `0` (STOP) <br> `1` (COUNT_DOWN) <br> `2` (COUNT_UP) |
| `rightHours` | `uint8` | Hours for the right timer.                                                                              | `0-9`                           |
| `rightMinutes` | `uint8` | Minutes for the right timer.                                                                            | `0-59`                          |
| `rightSeconds` | `uint8` | Seconds for the right timer.                                                                            | `0-59`                          |

**Example**:
```json
{
  "command": "setTime",
  "id": "cmd-001",
  "params": {
    "leftMode": 1, "leftHours": 0, "leftMinutes": 5, "leftSeconds": 0,
    "rightMode": 1, "rightHours": 0, "rightMinutes": 5, "rightSeconds": 0
  }
}
```

#### `displayText`
Displays a custom text message on the DGT3000 screen. The gateway will automatically send an `endDisplay` command before displaying new text.

**Params**:
| Name         | Type    | Description                                                                                             | Constraints                     | Optional |
|--------------|---------|---------------------------------------------------------------------------------------------------------|---------------------------------|----------|
| `text`       | `string`| The text to display. Will be padded with spaces or truncated to 11 characters.                          | Max 11 characters               | No       |
| `beep`       | `uint8` | Beep duration.                                                                                          | `0-48` (0 = no beep, 48 = 3 seconds) | Yes      |
| `leftDots`   | `uint8` | Bitmask for dots/icons on the left display. Combine flags using bitwise OR.                             | See "Display Dots Flags" below (max: 63) | Yes      |
| `rightDots`  | `uint8` | Bitmask for dots/icons on the right display. Combine flags using bitwise OR.                            | See "Display Dots Flags" below  (max: 31)| Yes      |

**Display Dots Flags**:
*   `1` (`0x01`): Flag
*   `2` (`0x02`): White King
*   `4` (`0x04`): Black King
*   `8` (`0x08`): Colon
*   `16` (`0x10`): Dot
*   `32` (`0x20`): Extra Dot (Left side only)

**Example**:
```json
{
  "command": "displayText",
  "id": "cmd-002",
  "params": {
    "text": "HELLO WORLD",
    "beep": 10,
    "leftDots": 9, // 1 | 8,  Flag and Colon
    "rightDots": 2     // White King
  }
}
```
**Example (basic text)**:
```json
{
  "command": "displayText",
  "id": "cmd-003",
  "params": {
    "text": "HELLO"
  }
}
```

#### `endDisplay`
Stops displaying custom text and returns the DGT3000 screen to the time display.

**Params**: None.

**Example**:
```json
{
  "command": "endDisplay",
  "id": "cmd-004"
}
```

#### `stop`
Stops the clocks. The current time will remain displayed.

**Params**: None.

**Example**:
```json
{
  "command": "stop",
  "id": "cmd-005"
}
```

#### `run`
Starts the clocks with the currently set time.

**Params**:
| Name        | Type    | Description                                                                                             | Constraints                     |
|-------------|---------|---------------------------------------------------------------------------------------------------------|---------------------------------|
| `leftMode`  | `uint8` | DGT mode for the left timer. Determines how the timer behaves.                                          | `0` (STOP) <br> `1` (COUNT_DOWN) <br> `2` (COUNT_UP) |
| `rightMode` | `uint8` | DGT mode for the right timer. Determines how the timer behaves.                                         | `0` (STOP) <br> `1` (COUNT_DOWN) <br> `2` (COUNT_UP) |

**Example**:
```json
{
  "command": "run",
  "id": "cmd-006",
  "params": {
    "leftMode": 1,
    "rightMode": 1
  }
}
```

#### `getTime`
Requests the current time from both clocks. The result is sent in a `command_response`.

**Params**: None.

**Example**:
```json
{
  "command": "getTime",
  "id": "cmd-007"
}
```

## 5. Responses & Events (Gateway â†’ Client)
All messages from the gateway are sent as notifications on the `Event` Characteristic (`...-0003`). They are identified by a `type` field.

### Command Response (`command_response`)
This message is sent in response to a command initiated by the client.

#### Success Structure
```json
{
  "type": "command_response",
  "id": "unique_command_id",
  "status": "success",
  "result": { ... }
}
```
*   `id` (string): Mirrors the `id` of the original command.
*   `status` (string): Will be `"success"`.
*   `result` (object): An object containing the data returned by the command (e.g., for `getTime`). For commands that don't return specific data, it may contain a simple status message.

**Example (`getTime` success response)**:
```json
{
  "type": "command_response",
  "id": "cmd-007",
  "status": "success",
  "result": {
    "leftHours": 0,
    "leftMinutes": 5,
    "leftSeconds": 0,
    "rightHours": 0,
    "rightMinutes": 5,
    "rightSeconds": 0
  }
}
```

**Example (`setTime` success response)**:
```json
{
  "type": "command_response",
  "id": "cmd-001",
  "status": "success",
  "result": {
    "status": "Time set successfully"
  }
}
```

#### Error Structure
```json
{
  "type": "command_response",
  "id": "unique_command_id",
  "status": "error",
  "data": {
    "errorCode": 101,
    "errorMessage": "I2C Communication Error"
  }
}
```
*   `id` (string): Mirrors the `id` of the original command.
*   `status` (string): Will be `"error"`.
*   `data.errorCode` (uint16): A numerical code for the error (see Section 7: "System Error Codes").
*   `data.errorMessage` (string): A human-readable error message.

**Example (error response)**:
```json
{
  "type": "command_response",
  "id": "cmd-002",
  "status": "error",
  "data": {
    "errorCode": 1102,
    "errorMessage": "Invalid JSON Parameters"
  }
}
```

### Asynchronous Events
These events are sent by the gateway without a prior client request. All events include a `timestamp` field (milliseconds since boot).

#### Button Event (`buttonEvent`)
Sent when a physical button or the lever on the DGT3000 changes state.
*   For the **main 5 buttons** (`back`, `minus`, `play_pause`, `plus`, `forward`), this event is primarily triggered when the button is *pressed down*.
*   For the **On/Off button** and the **lever**, both the *press/down* and *release/up* states are reported.
Repeat events are sent if a button is held down.

**Structure**:
```json
{
  "type": "buttonEvent",
  "timestamp": 123456,
  "data": {
    "button": "lever_right",
    "buttonCode": 64,
    "isRepeat": false,
    "repeatCount": 0
  }
}
```
*   `data.button` (string): The name of the button/event. Possible values:
    *   `"back"`, `"minus"`, `"play_pause"`, `"plus"`, `"forward"`
    *   `"on_off_press"`: The power button was pressed.
    *   `"on_off_release"`: The power button was released (only occurs if the clock stays on).
    *   `"lever_right"`: The lever was moved to the right.
    *   `"lever_left"`: The lever was moved to the left.
    *   `"unknown"`
*   `data.buttonCode` (uint8): The raw button code from the clock.
*   `data.isRepeat` (boolean): `true` if this is a repeated event from a long press.
*   `data.repeatCount` (uint32, optional): Indicates the number of times this specific repeat event has fired. Only present if `isRepeat` is `true`.

#### Connection Status Event (`connectionStatus`)
Sent when the gateway's connection to the DGT3000 clock changes, or when a new BLE client subscribes to events (as an initial status update).

**Structure**:
```json
{
  "type": "connectionStatus",
  "timestamp": 123456,
  "data": {
    "connected": true,
    "configured": true
  }
}
```
*   `data.connected` (boolean): `true` if the I2C connection to the DGT3000 is physically active.
*   `data.configured` (boolean): `true` if the DGT3000 has been successfully initialized and configured by the gateway.

#### Error Event (`error`)
Sent when a system-level or I2C communication error occurs that affects the gateway's operation.

**Structure**:
```json
{
  "type": "error",
  "timestamp": 123456,
  "data": {
    "errorCode": 101,
    "errorMessage": "I2C CRC Error"
  }
}
```
*   `data.errorCode` (uint16): A numerical code for the error (see Section 7: "System Error Codes").
*   `data.errorMessage` (string): A human-readable error message.

#### Time Update Event (`timeUpdate`)
Sent periodically when the clock's time changes

**Structure**:
```json
{
  "type": "timeUpdate",
  "timestamp": 123456,
  "data": {
    "leftHours": 0,
    "leftMinutes": 5,
    "leftSeconds": 0,
    "rightHours": 0,
    "rightMinutes": 5,
    "rightSeconds": 0
  }
}
```
*   `data.leftHours` (uint8): Hours for the left timer.
*   `data.leftMinutes` (uint8): Minutes for the left timer.
*   `data.leftSeconds` (uint8): Seconds for the left timer.
*   `data.rightHours` (uint8): Hours for the right timer.
*   `data.rightMinutes` (uint8): Minutes for the right timer.
*   `data.rightSeconds` (uint8): Seconds for the right timer.

## 6. Status Characteristic
Reading this characteristic (`...-0004`) returns a JSON object with a snapshot of the system's health and operational state.

**Example Response**:
```json
{
  "systemState": "Active",
  "bleConnected": true,
  "dgtConnected": true,
  "dgtConfigured": true,
  "uptime": 50000,
  "freeHeap": 150,
  "temperature": 25,
  "commandsProcessed": 10,
  "eventsGenerated": 42,
  "notificationsSent": 52,
  "notificationsFailed": 0,
  "rawCmdQueueDepth": 0,
  "evtQueueDepth": 0,
  "respQueueDepth": 0,
  "queuesHealthy": true
}
```

**Fields**:
| Field Name          | Type     | Description                                                                 |
|---------------------|----------|-----------------------------------------------------------------------------|
| `systemState`       | `string` | Current state of the gateway. Possible values: `Uninitialized`, `Initializing`, `Idle`, `Active`, `Error Recovery`. |
| `bleConnected`      | `boolean`| `true` if a BLE client is currently connected.                              |
| `dgtConnected`      | `boolean`| `true` if the gateway has an active I2C connection to the DGT3000 clock.  |
| `dgtConfigured`     | `boolean`| `true` if the DGT3000 clock has been successfully initialized and configured. |
| `uptime`            | `uint32` | Milliseconds since the gateway booted.                                      |
| `freeHeap`          | `uint32` | Free heap memory in KB.                                                     |
| `temperature`       | `int16`  | Internal temperature of the ESP32 in Celsius. `-999` if read fails.         |
| `commandsProcessed` | `uint32` | Counter for total commands processed by the I2C task.                     |
| `eventsGenerated`   | `uint32` | Counter for total events generated by the I2C task.                       |
| `notificationsSent` | `uint32` | Total BLE notifications successfully sent.                                  |
| `notificationsFailed` | `uint32` | Total BLE notifications that failed to send.                                |
| `rawCmdQueueDepth`  | `uint16` | Current number of raw commands waiting in the queue (BLE -> I2C Task).    |
| `evtQueueDepth`     | `uint16` | Current number of events waiting in the queue (I2C Task -> BLE).          |
| `respQueueDepth`    | `uint16` | Current number of command responses waiting in the queue.                   |
| `queuesHealthy`     | `boolean`| `true` if internal queues are not overloaded (below 80% utilization).     |

## 7. System Error Codes
The `errorCode` field in error responses and events will be one of the following:

| Code  | Name                      | Description                                                                 |
|-------|---------------------------|-----------------------------------------------------------------------------|
| `0`   | `SUCCESS`                 | No error.                                                                   |
| `1000`| `I2C Communication Error` | A generic I2C bus error occurred, or hardware initialization failed.        |
| `1001`| `DGT Not Configured`      | The DGT clock is not configured when a command requiring it was sent.       |
| `1002`| `I2C CRC Error`           | A CRC check failed on an I2C message received from the DGT3000.             |
| `1003`| `DGT Not Connected`       | The DGT clock is not physically connected or responding.                    |
| `1100`| `JSON Parse Error`        | The received command string was not valid JSON.                             |
| `1101`| `Invalid JSON Command`    | The `command` field was missing, or the command name is not recognized.     |
| `1102`| `Invalid JSON Parameters` | A required parameter was missing, or had an invalid type/value for the command. |
| `1200`| `Command Timeout`         | The DGT clock did not respond to a command in time.                         |
| `2000`| `Unknown Error`           | An unspecified error occurred.                                              |
